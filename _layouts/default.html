<!DOCTYPE html>
<html lang="{{ page.lang | default: site.lang | default: 'en' }}">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  {% seo %}
  <link rel="stylesheet" href="{{ '/assets/css/main.css' | relative_url }}">
  <link rel="alternate" type="application/atom+xml" title="{{ site.title }}" href="{{ '/feed.xml' | relative_url }}">

  <!-- KaTeX (math rendering) -->
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.16.11/dist/katex.min.css">
  <script defer src="https://cdn.jsdelivr.net/npm/katex@0.16.11/dist/katex.min.js"></script>
  <script defer src="https://cdn.jsdelivr.net/npm/katex@0.16.11/dist/contrib/auto-render.min.js"
    onload="renderMathInElement(document.body, {
      delimiters: [
        {left: '$$', right: '$$', display: true},
        {left: '\\[', right: '\\]', display: true},
        {left: '\\begin{align}', right: '\\end{align}', display: true},
        {left: '\\begin{align*}', right: '\\end{align*}', display: true},
        {left: '\\begin{aligned}', right: '\\end{aligned}', display: true},
        {left: '\\begin{equation}', right: '\\end{equation}', display: true},
        {left: '\\begin{equation*}', right: '\\end{equation*}', display: true},
        {left: '\\begin{gather}', right: '\\end{gather}', display: true},
        {left: '\\begin{gather*}', right: '\\end{gather*}', display: true},
        {left: '$', right: '$', display: false},
        {left: '\\(', right: '\\)', display: false}
      ],
      throwOnError: false
    });"></script>

  <!-- highlight.js (code syntax highlighting) -->
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/highlightjs/cdn-release@11.10.0/build/styles/github.min.css">
  <script defer src="https://cdn.jsdelivr.net/gh/highlightjs/cdn-release@11.10.0/build/highlight.min.js"></script>

  <script>
    window.__obsidianDocs = [];
    (function() {
      function addDoc(doc) {
        if (!doc || !doc.url) return;
        if (/\.(xml|txt|json|rss|atom)$/i.test(doc.url)) return;
        if (doc.url === '/404.html' || doc.url === '/404') return;
        window.__obsidianDocs.push(doc);
      }

      {% for doc in site.posts %}
      {% assign raw_slug = doc.basename_without_ext | default: (doc.path | split: '/' | last | split: '.' | first) %}
      {% assign slug = raw_slug %}
      {% assign slug_parts = raw_slug | split: '-' %}
      {% if slug_parts.size > 3 and slug_parts[0].size == 4 and slug_parts[1].size == 2 and slug_parts[2].size == 2 %}
      {% assign stripped_parts = slug_parts | slice: 3, 200 %}
      {% assign slug = stripped_parts | join: '-' %}
      {% endif %}
      {% if slug == '' %}
      {% assign slug = raw_slug %}
      {% endif %}
      addDoc({
        "slug": {{ slug | jsonify }},
        "legacySlug": {{ raw_slug | jsonify }},
        "title": {{ doc.title | default: doc.name | default: doc.url | jsonify }},
        "url": {{ doc.url | relative_url | jsonify }},
        "graph": {% if doc.graph == false %}false{% else %}true{% endif %}
      });
      {% endfor %}

      {% for doc in site.pages %}
      {% assign doc_ext = doc.path | split: '.' | last | downcase %}
      {% if doc_ext == 'md' or doc_ext == 'markdown' or doc_ext == 'mkdown' or doc_ext == 'mkdn' or doc_ext == 'mkd' %}
      addDoc({
        "slug": {{ doc.basename_without_ext | default: (doc.path | split: '/' | last | split: '.' | first) | jsonify }},
        "legacySlug": {{ doc.basename_without_ext | default: (doc.path | split: '/' | last | split: '.' | first) | jsonify }},
        "title": {{ doc.title | default: doc.name | default: doc.url | jsonify }},
        "url": {{ doc.url | relative_url | jsonify }},
        "graph": {% if doc.graph == true %}true{% else %}false{% endif %}
      });
      {% endif %}
      {% endfor %}
    })();
  </script>
</head>
<body>
  <header class="site-header">
    <div class="container">
      <a class="site-title" href="{{ '/' | relative_url }}">{{ site.title }}</a>
      <nav class="site-nav">
        {% for link in site.data.navigation.main %}
          <a href="{{ link.url | relative_url }}"{% if page.url == link.url %} class="active"{% endif %}>{{ link.title }}</a>
        {% endfor %}
      </nav>
    </div>
  </header>

  <main class="site-content">
    <div class="container">
      {{ content }}
    </div>
  </main>

  <footer class="site-footer">
    <div class="container">
      <p>&copy; {{ site.time | date: '%Y' }} {{ site.title }}</p>
    </div>
  </footer>

  <!-- Obsidian Callouts (client-side transform) -->
  <script>
  (function() {
    var CALLOUT_COLORS = {
      note:'#448aff', info:'#448aff', tip:'#00bfa5', hint:'#00bfa5',
      warning:'#ff9100', caution:'#ff9100', important:'#ff6d00',
      danger:'#ff5252', error:'#ff5252', bug:'#ff5252',
      example:'#7c4dff', quote:'#9e9e9e', cite:'#9e9e9e',
      abstract:'#00b8d4', summary:'#00b8d4', tldr:'#00b8d4',
      todo:'#448aff', success:'#00c853', check:'#00c853', done:'#00c853',
      question:'#ff9100', help:'#ff9100', faq:'#ff9100',
      failure:'#ff5252', fail:'#ff5252', missing:'#ff5252'
    };
    var CALLOUT_ICONS = {
      note:'<svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M12 20h9"/><path d="M16.376 3.622a1 1 0 0 1 3.002 3.002L7.368 18.635a2 2 0 0 1-.855.506l-2.872.838a.5.5 0 0 1-.62-.62l.838-2.872a2 2 0 0 1 .506-.854z"/></svg>',
      info:'<svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="10"/><path d="M12 16v-4"/><path d="M12 8h.01"/></svg>',
      tip:'<svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M15 14c.2-1 .7-1.7 1.5-2.5 1-.9 1.5-2.2 1.5-3.5A6 6 0 0 0 6 8c0 1 .2 2.2 1.5 3.5.7.7 1.3 1.5 1.5 2.5"/><path d="M9 18h6"/><path d="M10 22h4"/></svg>',
      warning:'<svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="m21.73 18-8-14a2 2 0 0 0-3.48 0l-8 14A2 2 0 0 0 4 21h16a2 2 0 0 0 1.73-3"/><path d="M12 9v4"/><path d="M12 17h.01"/></svg>',
      danger:'<svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polygon points="13 2 3 14 12 14 11 22 21 10 12 10 13 2"/></svg>',
      bug:'<svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="m8 2 1.88 1.88"/><path d="M14.12 3.88 16 2"/><path d="M9 7.13v-1a3.003 3.003 0 1 1 6 0v1"/><path d="M12 20c-3.3 0-6-2.7-6-6v-3a4 4 0 0 1 4-4h4a4 4 0 0 1 4 4v3c0 3.3-2.7 6-6 6"/><path d="M12 20v-9"/><path d="M6.53 9C4.6 8.8 3 7.1 3 5"/><path d="M6 13H2"/><path d="M3 21c0-2.1 1.7-3.9 3.8-4"/><path d="M20.97 5c0 2.1-1.6 3.8-3.5 4"/><path d="M22 13h-4"/><path d="M17.2 17c2.1.1 3.8 1.9 3.8 4"/></svg>',
      example:'<svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M4 2v20l2-1 2 1 2-1 2 1 2-1 2 1 2-1 2 1V2l-2 1-2-1-2 1-2-1-2 1-2-1-2 1Z"/><path d="M14 8H8"/><path d="M16 12H8"/><path d="M13 16H8"/></svg>',
      quote:'<svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M16 3a2 2 0 0 0-2 2v6a2 2 0 0 0 2 2 1 1 0 0 1 1 1v1a2 2 0 0 1-2 2 1 1 0 0 0-1 1v2a1 1 0 0 0 1 1 6 6 0 0 0 6-6V5a2 2 0 0 0-2-2z"/><path d="M5 3a2 2 0 0 0-2 2v6a2 2 0 0 0 2 2 1 1 0 0 1 1 1v1a2 2 0 0 1-2 2 1 1 0 0 0-1 1v2a1 1 0 0 0 1 1 6 6 0 0 0 6-6V5a2 2 0 0 0-2-2z"/></svg>',
      abstract:'<svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M15 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V7Z"/><path d="M14 2v4a2 2 0 0 0 2 2h4"/></svg>',
      todo:'<svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="m9 11 3 3L22 4"/><path d="M21 12v7a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h11"/></svg>',
      success:'<svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M22 11.08V12a10 10 0 1 1-5.93-9.14"/><path d="m9 11 3 3L22 4"/></svg>',
      question:'<svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="10"/><path d="M9.09 9a3 3 0 0 1 5.83 1c0 2-3 3-3 3"/><path d="M12 17h.01"/></svg>',
      failure:'<svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="10"/><path d="m15 9-6 6"/><path d="m9 9 6 6"/></svg>'
    };
    // Aliases
    var ALIASES = {hint:'tip',important:'warning',caution:'warning',error:'danger',cite:'quote',summary:'abstract',tldr:'abstract',check:'success',done:'success',help:'question',faq:'question',fail:'failure',missing:'failure'};

    document.querySelectorAll('blockquote').forEach(function(bq) {
      var firstP = bq.querySelector('p');
      if (!firstP) return;
      var html = firstP.innerHTML;
      var m = html.match(/^\[!(\w+)\]([+-]?)[ \t]*/);
      if (!m) return;

      var rawType = m[1].toLowerCase();
      var fold = m[2];
      var rest = html.substring(m[0].length);

      var cssType = ALIASES[rawType] || rawType;
      var color = CALLOUT_COLORS[cssType] || '#448aff';
      var icon = CALLOUT_ICONS[cssType] || CALLOUT_ICONS['note'];

      // Split title from body at first <br> or newline
      var parts = rest.split(/\n|<br\s*\/?>/);
      var title = (parts[0] || '').trim() || rawType.charAt(0).toUpperCase() + rawType.slice(1);
      var bodyFromFirstP = parts.slice(1).join('<br>').trim();

      // Collect remaining children of blockquote (after first <p>)
      var bodyParts = [];
      if (bodyFromFirstP) bodyParts.push('<p>' + bodyFromFirstP + '</p>');
      var sibling = firstP.nextElementSibling;
      while (sibling) {
        bodyParts.push(sibling.outerHTML);
        sibling = sibling.nextElementSibling;
      }
      var bodyHTML = bodyParts.join('');

      var chevron = '<svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="m6 9 6 6 6-6"/></svg>';

      if (fold) {
        var details = document.createElement('details');
        details.className = 'callout callout-' + cssType;
        if (fold === '+') details.open = true;
        details.style.setProperty('--callout-color', color);
        details.innerHTML =
          '<summary class="callout-title">' +
            '<div class="callout-icon">' + icon + '</div>' +
            '<div class="callout-title-inner">' + title + '</div>' +
            '<div class="callout-fold">' + chevron + '</div>' +
          '</summary>' +
          '<div class="callout-content">' + bodyHTML + '</div>';
        bq.replaceWith(details);
      } else {
        var div = document.createElement('div');
        div.className = 'callout callout-' + cssType;
        div.style.setProperty('--callout-color', color);
        div.innerHTML =
          '<div class="callout-title">' +
            '<div class="callout-icon">' + icon + '</div>' +
            '<div class="callout-title-inner">' + title + '</div>' +
          '</div>' +
          '<div class="callout-content">' + bodyHTML + '</div>';
        bq.replaceWith(div);
      }
    });
  })();
  </script>

  <!-- Obsidian Wikilink fallback (works even when server-side plugin is unavailable) -->
  <script>
  (function() {
    var docs = Array.isArray(window.__obsidianDocs) ? window.__obsidianDocs : [];

    function normPath(url) {
      if (!url) return null;
      try {
        var u = new URL(url, window.location.origin);
        return (u.pathname || '/').replace(/\/+$/, '') || '/';
      } catch (e) {
        return null;
      }
    }

    function addLookup(lookup, key, doc) {
      if (!key) return;
      lookup[key] = doc;
      lookup[key.toLowerCase()] = doc;
    }

    var wikilinkLookup = {};
    docs.forEach(function(doc) {
      if (!doc || !doc.url) return;
      var normalized = normPath(doc.url);
      var title = doc.title || '';
      var slug = doc.slug || '';
      var legacySlug = doc.legacySlug || '';
      var entry = {
        url: normalized || doc.url,
        title: title,
        slug: slug,
        legacySlug: legacySlug
      };
      addLookup(wikilinkLookup, slug, entry);
      addLookup(wikilinkLookup, legacySlug, entry);
      addLookup(wikilinkLookup, title, entry);
      if (normalized) {
        addLookup(wikilinkLookup, normalized, entry);
        addLookup(wikilinkLookup, normalized.replace(/^\//, ''), entry);
      }
    });

    function resolveWikilink(key, display) {
      var cleanKey = (key || '').trim();
      var cleanDisplay = display ? display.trim() : '';
      if (!cleanKey) return { href: null, text: cleanDisplay || '' };
      var info = wikilinkLookup[cleanKey] || wikilinkLookup[cleanKey.toLowerCase()];
      if (info && info.url) {
        return {
          href: info.url,
          text: cleanDisplay || info.title || cleanKey
        };
      }
      return {
        href: null,
        text: cleanDisplay || cleanKey
      };
    }

    function appendWikilinkText(fragment, text) {
      var pattern = /\[\[([^\]|]+?)(?:\|([^\]]+?))?\]\]/g;
      var last = 0;
      var match;

      while ((match = pattern.exec(text))) {
        if (match.index > last) {
          fragment.appendChild(document.createTextNode(text.slice(last, match.index)));
        }
        var key = (match[1] || '').trim();
        var display = match[2] ? match[2].trim() : '';
        var resolved = resolveWikilink(key, display);
        if (resolved.href) {
          var a = document.createElement('a');
          a.href = resolved.href;
          a.textContent = resolved.text;
          fragment.appendChild(a);
        } else {
          fragment.appendChild(document.createTextNode(resolved.text));
        }
        last = match.index + match[0].length;
      }

      if (last < text.length) {
        fragment.appendChild(document.createTextNode(text.slice(last)));
      }
    }

    function hasSplitWikilinkCells(cells) {
      return Array.prototype.some.call(cells, function(cell) {
        var text = cleanCellText(cell);
        if (!text) return false;
        var hasOpen = text.indexOf('[[') !== -1;
        var hasClose = text.indexOf(']]') !== -1;
        return hasOpen !== hasClose;
      });
    }

    function cleanCellText(cell) {
      return (cell && cell.textContent ? cell.textContent : '').replace(/\u00a0/g, ' ').trim();
    }

    function hasSplitMathCells(cells) {
      if (!cells || cells.length < 2) return false;
      var parts = Array.prototype.map.call(cells, cleanCellText).filter(Boolean);
      if (parts.length < 2) return false;
      var rowText = parts.join('|');
      if (rowText.indexOf('|') === -1) return false;
      if (/\$[^$]*\|[^$]*\$/.test(rowText)) return true;
      if (/\\\([^)\n]*\|[^)\n]*\\\)/.test(rowText)) return true;
      if (/\\\[[\s\S]*?\|[\s\S]*?\\\]/.test(rowText)) return true;
      return false;
    }

    function looksLikeAccidentalSplitTable(table) {
      if (!table) return false;
      if (table.querySelector('thead')) return false;

      var rows = table.querySelectorAll('tr');
      if (!rows.length) return false;

      var maxCells = 0;
      var shortCellCount = 0;

      rows.forEach(function(row) {
        var cells = row.querySelectorAll('td, th');
        if (!cells.length) return;
        if (cells.length > maxCells) maxCells = cells.length;
        Array.prototype.forEach.call(cells, function(cell) {
          var text = cleanCellText(cell);
          if (!text) return;
          if (text.length <= 24 && /^[A-Za-z0-9_\-\+\^\{\}\(\)\[\]\\\/=<>.,:;]+$/.test(text)) {
            shortCellCount += 1;
          }
        });
      });

      if (maxCells < 2) return false;

      if (table.closest('li') && maxCells >= 3) return true;
      if (rows.length <= 2 && maxCells >= 4) return true;
      if (shortCellCount >= 2 && maxCells >= 3) return true;

      return false;
    }

    function replaceWikilinkTables(root) {
      root.querySelectorAll('table').forEach(function(table) {
        var rows = table.querySelectorAll('tr');
        if (!rows.length) return;

        var shouldFix = looksLikeAccidentalSplitTable(table);
        rows.forEach(function(row) {
          var cells = row.querySelectorAll('td, th');
          if (!cells.length) return;
          if (hasSplitWikilinkCells(cells)) shouldFix = true;
          if (hasSplitMathCells(cells)) shouldFix = true;
        });

        if (!shouldFix) return;

        var wrapper = document.createElement('div');
        wrapper.className = 'wikilink-table-fix';
        wrapper.setAttribute('data-needs-math-render', '1');

        rows.forEach(function(row) {
          var cells = row.querySelectorAll('td, th');
          if (!cells.length) return;
          var parts = Array.prototype.map.call(cells, cleanCellText).filter(Boolean);
          if (!parts.length) return;
          var line = parts.join('|').trim();
          if (!line) return;
          var p = document.createElement('p');
          var frag = document.createDocumentFragment();
          appendWikilinkText(frag, line);
          p.appendChild(frag);
          wrapper.appendChild(p);
        });

        if (wrapper.childNodes.length) {
          table.replaceWith(wrapper);
        }
      });
    }

    function replaceRawWikilinks(root) {
      var pattern = /\[\[([^\]|]+?)(?:\|([^\]]+?))?\]\]/g;
      var disallowed = { a: true, code: true, pre: true, script: true, style: true, textarea: true };
      var walker = document.createTreeWalker(root, NodeFilter.SHOW_TEXT, {
        acceptNode: function(node) {
          if (!node.nodeValue || node.nodeValue.indexOf('[[') === -1) return NodeFilter.FILTER_REJECT;
          var parent = node.parentNode;
          while (parent && parent.nodeType === 1) {
            var tag = parent.tagName.toLowerCase();
            if (disallowed[tag]) return NodeFilter.FILTER_REJECT;
            parent = parent.parentNode;
          }
          return NodeFilter.FILTER_ACCEPT;
        }
      });

      var nodes = [];
      var current;
      while ((current = walker.nextNode())) nodes.push(current);

      nodes.forEach(function(node) {
        var text = node.nodeValue;
        pattern.lastIndex = 0;
        if (!pattern.test(text)) return;
        pattern.lastIndex = 0;

        var frag = document.createDocumentFragment();
        var last = 0;
        var match;
        while ((match = pattern.exec(text))) {
          if (match.index > last) {
            frag.appendChild(document.createTextNode(text.slice(last, match.index)));
          }
          var key = (match[1] || '').trim();
          var display = match[2] ? match[2].trim() : '';
          var resolved = resolveWikilink(key, display);
          if (resolved.href) {
            var a = document.createElement('a');
            a.href = resolved.href;
            a.textContent = resolved.text;
            frag.appendChild(a);
          } else {
            frag.appendChild(document.createTextNode(resolved.text));
          }
          last = match.index + match[0].length;
        }

        if (last < text.length) {
          frag.appendChild(document.createTextNode(text.slice(last)));
        }
        node.replaceWith(frag);
      });
    }

    function fixWikilinks(root) {
      var targetRoot = root || document;
      replaceWikilinkTables(targetRoot);
      replaceRawWikilinks(targetRoot);
    }

    function rerenderMath(root) {
      if (typeof renderMathInElement !== 'function') return;
      var targets = [];
      if (root && root.matches && root.matches('.wikilink-table-fix[data-needs-math-render="1"]')) {
        targets.push(root);
      }
      if (root && root.querySelectorAll) {
        targets = targets.concat(Array.prototype.slice.call(root.querySelectorAll('.wikilink-table-fix[data-needs-math-render="1"]')));
      }
      if (!targets.length) return;

      targets.forEach(function(target) {
        renderMathInElement(target, {
          delimiters: [
            { left: '$$', right: '$$', display: true },
            { left: '\\[', right: '\\]', display: true },
            { left: '\\begin{align}', right: '\\end{align}', display: true },
            { left: '\\begin{align*}', right: '\\end{align*}', display: true },
            { left: '\\begin{aligned}', right: '\\end{aligned}', display: true },
            { left: '\\begin{equation}', right: '\\end{equation}', display: true },
            { left: '\\begin{equation*}', right: '\\end{equation*}', display: true },
            { left: '\\begin{gather}', right: '\\end{gather}', display: true },
            { left: '\\begin{gather*}', right: '\\end{gather*}', display: true },
            { left: '$', right: '$', display: false },
            { left: '\\(', right: '\\)', display: false }
          ],
          throwOnError: false
        });
        target.removeAttribute('data-needs-math-render');
      });
    }

    window.__obsidianResolveWikilink = resolveWikilink;
    window.__obsidianFixWikilinks = fixWikilinks;

    var apply = function() {
      var target = document.querySelector('.post-content') || document.querySelector('.page-content');
      if (target) {
        fixWikilinks(target);
        rerenderMath(target);
        return true;
      }
      return false;
    };

    // Run immediately so accidental markdown tables are fixed before KaTeX auto-render runs.
    var applied = apply();
    if (!applied && document.readyState === 'loading') {
      document.addEventListener('DOMContentLoaded', apply);
    }
  })();
  </script>

  <!-- Obsidian inline tag links (#tag, #parent/child) -->
  <script>
  (function() {
    var tagPageUrl = {{ '/tags/' | relative_url | jsonify }};
    var tagPattern = /#([A-Za-z0-9_\-\u00C0-\u024F\u0370-\u03FF\u0400-\u04FF\u4E00-\u9FFF]+(?:\/[A-Za-z0-9_\-\u00C0-\u024F\u0370-\u03FF\u0400-\u04FF\u4E00-\u9FFF]+)*)/g;
    var disallowedTags = { a: true, code: true, pre: true, script: true, style: true, textarea: true };

    function isBoundary(ch) {
      if (!ch) return true;
      return /[\s(\[{<>"'`~!@$%^&*+=|\\:;,.?，。；：、]/.test(ch);
    }

    function isHexColorToken(token) {
      return /^#[0-9a-f]{3,8}$/i.test(token);
    }

    function hasBlockedAncestor(node) {
      var parent = node.parentNode;
      while (parent && parent.nodeType === 1) {
        var tag = parent.tagName.toLowerCase();
        if (disallowedTags[tag]) return true;
        if (parent.classList) {
          if (parent.classList.contains('katex') || parent.classList.contains('katex-display')) return true;
          if (parent.classList.contains('mermaid')) return true;
        }
        parent = parent.parentNode;
      }
      return false;
    }

    function convertInlineTags(root) {
      var walker = document.createTreeWalker(root, NodeFilter.SHOW_TEXT, {
        acceptNode: function(node) {
          if (!node.nodeValue || node.nodeValue.indexOf('#') === -1) return NodeFilter.FILTER_REJECT;
          if (hasBlockedAncestor(node)) return NodeFilter.FILTER_REJECT;
          return NodeFilter.FILTER_ACCEPT;
        }
      });

      var nodes = [];
      var node;
      while ((node = walker.nextNode())) nodes.push(node);

      nodes.forEach(function(textNode) {
        var text = textNode.nodeValue;
        tagPattern.lastIndex = 0;

        var last = 0;
        var found = false;
        var fragment = document.createDocumentFragment();
        var match;

        while ((match = tagPattern.exec(text))) {
          var token = match[0];
          var tagName = match[1];
          var start = match.index;
          var prev = start > 0 ? text[start - 1] : '';
          var next = tagPattern.lastIndex < text.length ? text[tagPattern.lastIndex] : '';

          if (!isBoundary(prev) || (!isBoundary(next) && next !== '/')) continue;
          if (isHexColorToken(token)) continue;

          if (start > last) {
            fragment.appendChild(document.createTextNode(text.slice(last, start)));
          }

          var a = document.createElement('a');
          a.className = 'inline-tag';
          a.textContent = token;
          a.href = tagPageUrl + '?q=' + encodeURIComponent(tagName);
          a.setAttribute('data-tag', tagName.toLowerCase());
          fragment.appendChild(a);

          last = tagPattern.lastIndex;
          found = true;
        }

        if (!found) return;
        if (last < text.length) {
          fragment.appendChild(document.createTextNode(text.slice(last)));
        }
        textNode.replaceWith(fragment);
      });
    }

    function apply() {
      var target = document.querySelector('.post-content') || document.querySelector('.page-content');
      if (!target) return;
      if (target.getAttribute('data-inline-tags-ready') === '1') return;
      convertInlineTags(target);
      target.setAttribute('data-inline-tags-ready', '1');
    }

    if (document.readyState === 'loading') {
      document.addEventListener('DOMContentLoaded', function() { setTimeout(apply, 0); });
    } else {
      setTimeout(apply, 0);
    }
  })();
  </script>

  <!-- Internal link hover preview (Obsidian-style page preview) -->
  <script>
  (function() {
    if (window.matchMedia && window.matchMedia('(hover: none), (pointer: coarse)').matches) return;

    var root = document.querySelector('.post-content') || document.querySelector('.page-content');
    if (!root) return;

    var previewCache = new Map();
    var popover = document.createElement('div');
    popover.className = 'link-preview-popover';
    popover.innerHTML = '<div class="link-preview-title"></div><div class="link-preview-body"></div>';
    document.body.appendChild(popover);

    var titleEl = popover.querySelector('.link-preview-title');
    var bodyEl = popover.querySelector('.link-preview-body');
    var hideTimer = null;
    var showTimer = null;
    var showToken = 0;
    var activeAnchor = null;
    var activePath = null;

    function norm(url) {
      if (!url) return null;
      try {
        var u = new URL(url, window.location.origin);
        var path = (u.pathname || '/').replace(/\/+$/, '') || '/';
        if (u.origin !== window.location.origin) return null;
        if (/\.(xml|txt|json|rss|atom|pdf|png|jpe?g|gif|webp|svg|mp4|mp3|zip)$/i.test(path)) return null;
        if (path === '/404' || path === '/404.html') return null;
        return path;
      } catch (e) {
        return null;
      }
    }

    function positionPopover(anchor) {
      var rect = anchor.getBoundingClientRect();
      var gap = 10;
      var width = popover.offsetWidth || 420;
      var height = popover.offsetHeight || 260;

      var left = rect.right + gap;
      var top = rect.top - 6;
      if (left + width > window.innerWidth - 8) {
        left = rect.left - width - gap;
      }
      if (left < 8) left = 8;
      if (top + height > window.innerHeight - 8) {
        top = window.innerHeight - height - 8;
      }
      if (top < 8) top = 8;

      popover.style.left = left + 'px';
      popover.style.top = top + 'px';
    }

    function hidePreviewNow() {
      clearTimeout(hideTimer);
      clearTimeout(showTimer);
      popover.classList.remove('is-visible', 'is-loading');
      activeAnchor = null;
      activePath = null;
    }

    function hidePreviewSoon() {
      clearTimeout(hideTimer);
      hideTimer = setTimeout(function() {
        hidePreviewNow();
      }, 140);
    }

    function extractPreview(html, path) {
      var parsed = new DOMParser().parseFromString(html, 'text/html');
      var titleNode = parsed.querySelector('.post-title') || parsed.querySelector('.page-title') || parsed.querySelector('h1');
      var contentRoot = parsed.querySelector('.post-content') || parsed.querySelector('.page-content') || parsed.body;

      var title = titleNode ? titleNode.textContent.trim() : path;
      if (!contentRoot) {
        return { title: title || path, html: '<p class="link-preview-empty">No preview content available.</p>' };
      }

      contentRoot.querySelectorAll('script, style, .graph-section, .backlinks, .footnotes').forEach(function(node) {
        node.remove();
      });

      var blocks = contentRoot.querySelectorAll('h2, h3, h4, p, ul, ol, blockquote, pre, table, .callout, img');
      var wrapper = document.createElement('div');
      var usedChars = 0;
      var usedBlocks = 0;

      for (var i = 0; i < blocks.length; i++) {
        var source = blocks[i];
        var text = (source.textContent || '').replace(/\s+/g, ' ').trim();
        var tag = source.tagName ? source.tagName.toLowerCase() : '';
        if (!text && tag !== 'img') continue;

        var clone = source.cloneNode(true);
        if ((tag === 'p' || tag === 'li') && text.length > 280) {
          clone.textContent = text.slice(0, 280) + '...';
        }

        wrapper.appendChild(clone);
        usedBlocks += 1;
        usedChars += text.length;

        if (usedBlocks >= 6 || usedChars >= 1100) break;
      }

      if (!wrapper.childNodes.length) {
        var fallbackText = (contentRoot.textContent || '').replace(/\s+/g, ' ').trim();
        wrapper.innerHTML = '<p class="link-preview-empty">' + (fallbackText ? fallbackText.slice(0, 280) + '...' : 'No preview content available.') + '</p>';
      }

      return {
        title: title || path,
        html: wrapper.innerHTML
      };
    }

    async function loadPreview(path) {
      if (previewCache.has(path)) return previewCache.get(path);
      var pending = fetch(path, { credentials: 'same-origin' })
        .then(function(resp) { return resp.ok ? resp.text() : ''; })
        .then(function(html) {
          if (!html) return { title: path, html: '<p class="link-preview-empty">Unable to load preview.</p>' };
          return extractPreview(html, path);
        })
        .catch(function() {
          return { title: path, html: '<p class="link-preview-empty">Unable to load preview.</p>' };
        });
      previewCache.set(path, pending);
      return pending;
    }

    function findAnchor(node) {
      while (node && node !== root) {
        if (node.nodeType === 1 && node.tagName.toLowerCase() === 'a') return node;
        node = node.parentNode;
      }
      return null;
    }

    function getPreviewPath(anchor) {
      if (!anchor) return null;
      var href = anchor.getAttribute('href');
      if (!href || href.charAt(0) === '#') return null;
      if (anchor.classList.contains('reversefootnote')) return null;
      var path = norm(anchor.href);
      var current = norm(window.location.href);
      if (!path || path === current) return null;
      return path;
    }

    function showPreview(anchor, path) {
      clearTimeout(hideTimer);
      clearTimeout(showTimer);
      activeAnchor = anchor;
      activePath = path;

      var token = ++showToken;
      titleEl.textContent = 'Loading...';
      bodyEl.innerHTML = '';
      popover.classList.add('is-visible', 'is-loading');
      positionPopover(anchor);

      loadPreview(path).then(function(preview) {
        if (token !== showToken) return;
        titleEl.textContent = preview.title;
        bodyEl.innerHTML = preview.html;

        if (typeof window.__obsidianFixWikilinks === 'function') {
          window.__obsidianFixWikilinks(bodyEl);
        }

        popover.classList.remove('is-loading');
        positionPopover(anchor);
      });
    }

    root.addEventListener('mouseover', function(event) {
      var anchor = findAnchor(event.target);
      if (!anchor) return;

      var path = getPreviewPath(anchor);
      if (!path) return;

      clearTimeout(hideTimer);
      clearTimeout(showTimer);
      showTimer = setTimeout(function() {
        showPreview(anchor, path);
      }, 170);
    });

    root.addEventListener('mouseout', function(event) {
      var anchor = findAnchor(event.target);
      if (!anchor) return;
      var to = event.relatedTarget;
      if (to && popover.contains(to)) return;
      if (to && anchor.contains(to)) return;
      hidePreviewSoon();
    });

    popover.addEventListener('mouseenter', function() {
      clearTimeout(hideTimer);
      clearTimeout(showTimer);
    });

    popover.addEventListener('mouseleave', function() {
      hidePreviewSoon();
    });

    root.addEventListener('mousemove', function(event) {
      if (!activeAnchor) return;
      var anchor = findAnchor(event.target);
      if (anchor && anchor === activeAnchor) {
        positionPopover(activeAnchor);
      }
    });

    window.addEventListener('scroll', function() {
      hidePreviewNow();
    }, { passive: true });

    window.addEventListener('resize', function() {
      hidePreviewNow();
    });
  })();
  </script>

  <!-- Mermaid (diagrams) -->
  <script type="module">
    import mermaid from 'https://cdn.jsdelivr.net/npm/mermaid@11/dist/mermaid.esm.min.mjs';
    mermaid.initialize({ startOnLoad: false, theme: 'default' });
    document.querySelectorAll('pre code.language-mermaid').forEach(function(el) {
      var pre = el.parentElement;
      var div = document.createElement('div');
      div.className = 'mermaid';
      div.textContent = el.textContent;
      pre.replaceWith(div);
    });
    await mermaid.run();
  </script>

  <!-- highlight.js init -->
  <script>
    document.addEventListener('DOMContentLoaded', function() {
      if (typeof hljs !== 'undefined') {
        document.querySelectorAll('pre code').forEach(function(el) {
          hljs.highlightElement(el);
        });
      }
    });
  </script>
</body>
</html>
