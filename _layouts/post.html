---
layout: default
---
<article class="post">
  <header class="post-header">
    <h1 class="post-title">{{ page.title }}</h1>
    <time class="post-date" datetime="{{ page.date | date_to_xmlschema }}">
      {{ page.date | date: "%Y-%m-%d" }}
    </time>
  </header>
  <div class="post-content">
    {{ content }}
  </div>

  {% if page.backlinks.size > 0 %}
  <section class="backlinks">
    <div class="backlinks-header">
      <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M10 13a5 5 0 0 0 7.54.54l3-3a5 5 0 0 0-7.07-7.07l-1.72 1.71"/><path d="M14 11a5 5 0 0 0-7.54-.54l-3 3a5 5 0 0 0 7.07 7.07l1.71-1.71"/></svg>
      <span>Links to this page</span>
    </div>
    <div class="backlinks-list">
      {% for bl in page.backlinks %}
      <a class="backlink-item" href="{{ bl.url | relative_url }}">{{ bl.title }}</a>
      {% endfor %}
    </div>
  </section>
  {% endif %}

  <section class="graph-section">
    <div class="graph-header">
      <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="18" cy="5" r="3"/><circle cx="6" cy="12" r="3"/><circle cx="18" cy="19" r="3"/><line x1="8.59" y1="13.51" x2="15.42" y2="17.49"/><line x1="15.41" y1="6.51" x2="8.59" y2="10.49"/></svg>
      <span>Interactive graph</span>
    </div>
    <div id="graph-container"></div>
  </section>
</article>

<script src="https://cdn.jsdelivr.net/npm/d3@7/dist/d3.min.js"></script>
<script>
(function() {
  var currentUrl = {{ page.url | jsonify }};
  var container = document.getElementById('graph-container');
  if (!container) return;

  var width = container.clientWidth || 300;
  var height = 280;

  fetch({{ '/assets/js/graph-data.json' | relative_url | jsonify }})
    .then(function(r) { return r.json(); })
    .then(function(data) {
      // Find current node
      var current = data.nodes.find(function(n) { return n.url === currentUrl; });
      if (!current) return;

      // Filter to local neighborhood (1 hop)
      var connectedIds = new Set([current.id]);
      data.links.forEach(function(l) {
        var s = typeof l.source === 'object' ? l.source.id : l.source;
        var t = typeof l.target === 'object' ? l.target.id : l.target;
        if (s === current.id) connectedIds.add(t);
        if (t === current.id) connectedIds.add(s);
      });

      var nodes = data.nodes.filter(function(n) { return connectedIds.has(n.id); });
      var nodeIds = new Set(nodes.map(function(n) { return n.id; }));
      var links = data.links.filter(function(l) {
        var s = typeof l.source === 'object' ? l.source.id : l.source;
        var t = typeof l.target === 'object' ? l.target.id : l.target;
        return nodeIds.has(s) && nodeIds.has(t);
      });

      if (nodes.length < 2) {
        container.innerHTML = '<p class="graph-empty">No connections yet</p>';
        return;
      }

      var svg = d3.select(container).append('svg')
        .attr('width', width)
        .attr('height', height)
        .attr('viewBox', [0, 0, width, height]);

      var simulation = d3.forceSimulation(nodes)
        .force('link', d3.forceLink(links).id(function(d) { return d.id; }).distance(80))
        .force('charge', d3.forceManyBody().strength(-200))
        .force('center', d3.forceCenter(width / 2, height / 2))
        .force('collision', d3.forceCollide().radius(30));

      var link = svg.append('g')
        .selectAll('line')
        .data(links)
        .join('line')
        .attr('class', 'graph-link');

      var node = svg.append('g')
        .selectAll('g')
        .data(nodes)
        .join('g')
        .attr('class', function(d) {
          return 'graph-node' + (d.id === current.id ? ' graph-node-current' : '');
        })
        .style('cursor', 'pointer')
        .on('click', function(event, d) {
          if (d.url && d.id !== current.id) window.location.href = d.url;
        })
        .call(d3.drag()
          .on('start', function(event, d) { if (!event.active) simulation.alphaTarget(0.3).restart(); d.fx = d.x; d.fy = d.y; })
          .on('drag', function(event, d) { d.fx = event.x; d.fy = event.y; })
          .on('end', function(event, d) { if (!event.active) simulation.alphaTarget(0); d.fx = null; d.fy = null; })
        );

      node.append('circle')
        .attr('r', function(d) { return d.id === current.id ? 8 : 5; });

      node.append('text')
        .text(function(d) { return d.name; })
        .attr('dy', -12)
        .attr('text-anchor', 'middle');

      simulation.on('tick', function() {
        link
          .attr('x1', function(d) { return d.source.x; })
          .attr('y1', function(d) { return d.source.y; })
          .attr('x2', function(d) { return d.target.x; })
          .attr('y2', function(d) { return d.target.y; });
        node.attr('transform', function(d) {
          d.x = Math.max(20, Math.min(width - 20, d.x));
          d.y = Math.max(20, Math.min(height - 20, d.y));
          return 'translate(' + d.x + ',' + d.y + ')';
        });
      });
    });
})();
</script>
